<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin — Quiz Results</title>
<style>
  body{ font-family:Arial, Helvetica, sans-serif; background:#0b1220; color:#e6eef8; margin:0; padding:20px;}
  .wrap{ max-width:1100px; margin:20px auto; }
  h1{ margin:0 0 10px 0; }
  table{ width:100%; border-collapse:collapse; background:#071026; border-radius:8px; overflow:hidden; }
  th,td{ padding:10px; border-bottom:1px solid rgba(255,255,255,0.04); text-align:left; font-size:13px; }
  th{ background:linear-gradient(90deg,#102233,#071026); }
  .controls{ margin:12px 0; display:flex; gap:10px; }
  .btn{ padding:8px 12px; border-radius:8px; border:none; cursor:pointer; background:#1e63ff; color:white; font-weight:700; }
  .small{ font-size:12px; color:rgba(255,255,255,0.7) }
  pre{ white-space:pre-wrap; word-break:break-word; background:rgba(255,255,255,0.02); padding:8px; border-radius:6px; }
</style>
</head>
<body>
  <div class="wrap">
    <h1>Admin — Saved Quiz Results</h1>
    <div class="controls">
      <button id="refreshBtn" class="btn">Refresh</button>
      <button id="exportCsv" class="btn">Export CSV</button>
      <div style="flex:1"></div>
      <a href="/" style="color:#9ad1ff; text-decoration:none" class="small">Open Quiz</a>
    </div>

    <div id="count" style="margin-bottom:10px;color:rgba(255,255,255,0.8)"></div>

    <div id="tableWrap"></div>
  </div>

<script>
async function fetchResults(){
  try {
    const r = await fetch('/results');
    if(!r.ok) throw new Error('Failed');
    const data = await r.json();
    renderTable(data);
  } catch(e){
    document.getElementById('tableWrap').innerHTML = '<p style="color:#f88">Could not load results</p>';
    console.error(e);
  }
}

function renderTable(data){
  document.getElementById('count').innerText = `${data.length} records`;
  if(data.length === 0){ document.getElementById('tableWrap').innerHTML = '<p>No records yet.</p>'; return; }

  const headers = ['#','timestamp','name','top','scores','answers'];
  let html = '<table><thead><tr>' + headers.map(h=>`<th>${h}</th>`).join('') + '</tr></thead><tbody>';
  data.forEach((rec,i)=>{
    // compute top
    const scores = rec.scores || {};
    let top = '—';
    if(Object.keys(scores).length) top = Object.keys(scores).reduce((a,b)=> (scores[a]||0) > (scores[b]||0) ? a : b);
    html += `<tr>
      <td>${i+1}</td>
      <td>${rec.timestamp || ''}</td>
      <td>${rec.name || 'Anonymous'}</td>
      <td>${top}</td>
      <td><pre>${JSON.stringify(rec.scores || {}, null, 2)}</pre></td>
      <td><pre>${JSON.stringify(rec.answers || [], null, 2)}</pre></td>
    </tr>`;
  });
  html += '</tbody></table>';
  document.getElementById('tableWrap').innerHTML = html;
}

function exportCSV(data){
  if(!data || !data.length) return alert('No data');
  const rows = [];
  // headers
  const headers = ['timestamp','name','top','scores_json','answers_json'];
  rows.push(headers.join(','));
  data.forEach(rec=>{
    const scores = rec.scores ? JSON.stringify(rec.scores).replace(/"/g,'""') : '';
    const answers = rec.answers ? JSON.stringify(rec.answers).replace(/"/g,'""') : '';
    const top = rec.scores ? Object.keys(rec.scores).reduce((a,b)=> (rec.scores[a]||0) > (rec.scores[b]||0) ? a : b) : '';
    rows.push([`"${rec.timestamp || ''}"`,`"${rec.name || ''}"`,`"${top}"`,`"${scores}"`,`"${answers}"`].join(','));
  });
  const csv = rows.join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'quiz-results.csv';
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

document.getElementById('refreshBtn').onclick = fetchResults;
document.getElementById('exportCsv').onclick = async ()=>{
  const r = await fetch('/results'); const data = await r.json(); exportCSV(data);
};

fetchResults();
</script>
</body>
</html>